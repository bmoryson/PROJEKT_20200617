  METHOD BORROW_BOOK.
    ME->GS_WSB_CUSTOMER = IS_CUSTOMER.

    DATA: IVALS     TYPE TABLE OF SVAL,
          XVALS     TYPE SVAL,
          LV_ID     TYPE CHAR12,
          LV_NAME   TYPE NAME1,
          LV_LINES  TYPE I,
          L_FLAG    TYPE FLAG,
          LV_AUTHOR TYPE CHAR50.

    FIELD-SYMBOLS <FS_WSB_BOOK> TYPE ZWSB_BOOK.

    SELECT SINGLE * FROM ZWSB_BOOK INTO me->gs_wsb_book
      WHERE last_customer EQ ME->GS_WSB_CUSTOMER-userid.
      IF sy-subrc EQ 0.
        RAISE BORROWED.
      ENDIF.

    XVALS-TABNAME   = 'ZWSB_BOOK'.
    XVALS-FIELDNAME = 'NAME'.
    APPEND XVALS TO IVALS.

    CALL FUNCTION 'POPUP_GET_VALUES'
      EXPORTING
        POPUP_TITLE     = 'Proszę o podanie tytułu'
      TABLES
        FIELDS          = IVALS
      EXCEPTIONS
        ERROR_IN_FIELDS = 1
        OTHERS          = 2.

    READ TABLE IVALS INTO XVALS WITH KEY FIELDNAME = 'NAME'.
    IF SY-SUBRC  = 0.
      LV_NAME = XVALS-VALUE.
    ENDIF.
    REFRESH IVALS[]. CLEAR XVALS-VALUE.

    SELECT * FROM ZWSB_BOOK INTO TABLE ME->GT_WSB_BOOK
      WHERE NAME EQ LV_NAME AND STATUS EQ 1.

    READ TABLE ME->GT_WSB_BOOK INTO ME->GS_WSB_BOOK INDEX 1.
    IF SY-SUBRC NE 0.
      RAISE NO_BOOK.
    ENDIF.

    LOOP AT ME->GT_WSB_BOOK[] ASSIGNING <FS_WSB_BOOK> WHERE AUTHOR NE ME->GS_WSB_BOOK-AUTHOR.
      XVALS-TABNAME   = 'ZWSB_BOOK'.
      XVALS-FIELDNAME = 'AUTHOR'.
      APPEND XVALS TO IVALS.
      CALL FUNCTION 'POPUP_GET_VALUES'
        EXPORTING
          POPUP_TITLE     = 'Proszę o podanie autora'
        TABLES
          FIELDS          = IVALS
        EXCEPTIONS
          ERROR_IN_FIELDS = 1
          OTHERS          = 2.
      READ TABLE IVALS INTO XVALS WITH KEY FIELDNAME = 'AUTHOR'.
      IF SY-SUBRC  = 0.
        LV_AUTHOR = XVALS-VALUE.
      ENDIF.
      REFRESH IVALS[]. CLEAR XVALS-VALUE.
      EXIT.
    ENDLOOP.

    IF LV_AUTHOR IS NOT INITIAL.
      REFRESH ME->GT_WSB_BOOK[].
      SELECT * FROM ZWSB_BOOK INTO TABLE ME->GT_WSB_BOOK
        WHERE NAME EQ LV_NAME AND AUTHOR EQ LV_AUTHOR.
    ENDIF.


    DESCRIBE TABLE ME->GT_WSB_BOOK LINES LV_LINES.
    IF LV_LINES EQ 0.
      RAISE NO_BOOK.
    ELSEIF LV_LINES GE 2.
      SORT ME->GT_WSB_BOOK BY NAME BOOK_DATE DESCENDING.
      DELETE ADJACENT DUPLICATES FROM ME->GT_WSB_BOOK COMPARING NAME.
      READ TABLE ME->GT_WSB_BOOK INTO ME->GS_WSB_BOOK INDEX 1.
    ELSE.
      READ TABLE ME->GT_WSB_BOOK INTO ME->GS_WSB_BOOK INDEX 1.
    ENDIF.

    ME->GS_WSB_BOOK-STATUS = 2.
    ME->GS_WSB_BOOK-LAST_CUSTOMER = ME->GS_WSB_CUSTOMER-USERID.
    GET TIME STAMP FIELD ME->GS_WSB_BOOK-LAST_CUSTOMER_AT.
    CLEAR ME->GS_WSB_BOOK-PLACEID.
    MODIFY ZWSB_BOOK FROM ME->GS_WSB_BOOK.



  ENDMETHOD.
